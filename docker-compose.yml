services:
  db:
    image: "postgres:15-alpine"
    restart: "always"
    environment:
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD:-dify_secure_password}"
      POSTGRES_DB: "${POSTGRES_DB:-dify}"
      PGDATA: "/var/lib/postgresql/data"
    volumes:
      - "db_data:/var/lib/postgresql/data"
    networks:
      - "dify_net"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: "10s"
      timeout: "5s"
      retries: 10
      start_period: "60s"

  redis:
    image: "redis:6-alpine"
    restart: "always"
    command: ["redis-server", "--requirepass", "${REDIS_PASSWORD:-dify_redis_secure_password}"]
    volumes:
      - "redis_data:/data"
    networks:
      - "dify_net"
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-dify_redis_secure_password}", "ping"]
      interval: "10s"
      timeout: "5s"
      retries: 10
      start_period: "30s"

  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    restart: always
    ports:
      - "11434:11434"
    volumes:
      - ./ollama_data:/root/.ollama
    networks:
      - "dify_net"
    # NVIDIA GPUを使用する場合は以下のコメントアウトを解除してください
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]

  weaviate:
    image: "semitechnologies/weaviate:1.19.0"
    restart: "always"
    networks:
      - "dify_net"
    environment:
      QUERY_DEFAULTS_LIMIT: "25"
      AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED: "true"
      DEFAULT_VECTORIZER_MODULE: "none"
      CLUSTER_HOSTNAME: "node1"
      PERSISTENCE_DATA_PATH: "/var/lib/weaviate"
    volumes:
      - "weaviate_data:/var/lib/weaviate"
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/v1/.well-known/ready || exit 1"]
      interval: "10s"
      timeout: "5s"
      retries: 10

  sandbox:
    image: "langgenius/dify-sandbox:0.2.10"
    restart: "always"
    environment:
      API_KEY: "dify-sandbox-api-key"
      GIN_MODE: "release"
    networks:
      - "dify_net"

  ssrf_proxy:
    image: "ubuntu/squid:latest"
    restart: "always"
    networks:
      - "dify_net"

  api:
    image: "langgenius/dify-api:0.10.2"
    restart: "always"
    ports:
      - "5001:5001"
    environment:
      DB_USERNAME: "postgres"
      DB_PASSWORD: "${POSTGRES_PASSWORD:-dify_secure_password}"
      DB_HOST: "db"
      DB_PORT: "5432"
      DB_DATABASE: "${POSTGRES_DB:-dify}"
      REDIS_HOST: "redis"
      REDIS_PORT: "6379"
      REDIS_PASSWORD: "${REDIS_PASSWORD:-dify_redis_secure_password}"
      VECTOR_STORE: "weaviate"
      WEAVIATE_ENDPOINT: "http://weaviate:8080"
      WEAVIATE_API_KEY: "WFA_KEY"
      SECRET_KEY: "${SECRET_KEY:-sk-shimon-0123456789-abcdefghijklmn}"
      MIGRATION_ENABLED: "true"
      CONSOLE_CORS_ALLOW_ORIGINS: "*"
      WEB_API_CORS_ALLOW_ORIGINS: "*"
      STORAGE_TYPE: "local"
      STORAGE_LOCAL_PATH: "/app/api/storage"
      OLLAMA_API_BASE: "http://ollama:11434"
      CODE_EXECUTION_ENDPOINT: "http://sandbox:8194"
      CODE_EXECUTION_API_KEY: "dify-sandbox-api-key"
      SSRF_PROXY_HTTP_URL: "http://ssrf_proxy:3128"
      SSRF_PROXY_HTTPS_URL: "http://ssrf_proxy:3128"
      CELERY_BROKER_URL: "redis://:${REDIS_PASSWORD:-dify_redis_secure_password}@redis:6379/1"
      CELERY_RESULT_BACKEND: "redis://:${REDIS_PASSWORD:-dify_redis_secure_password}@redis:6379/1"
    depends_on:
      db:
        condition: "service_healthy"
      redis:
        condition: "service_healthy"
      weaviate:
        condition: "service_healthy"
    volumes:
      - "./volumes/app/storage:/app/api/storage"
    networks:
      - "dify_net"

  worker:
    image: "langgenius/dify-api:0.10.2"
    restart: "always"
    environment:
      DB_USERNAME: "postgres"
      DB_PASSWORD: "${POSTGRES_PASSWORD:-dify_secure_password}"
      DB_HOST: "db"
      DB_PORT: "5432"
      DB_DATABASE: "${POSTGRES_DB:-dify}"
      REDIS_HOST: "redis"
      REDIS_PORT: "6379"
      REDIS_PASSWORD: "${REDIS_PASSWORD:-dify_redis_secure_password}"
      VECTOR_STORE: "weaviate"
      WEAVIATE_ENDPOINT: "http://weaviate:8080"
      WEAVIATE_API_KEY: "WFA_KEY"
      SECRET_KEY: "${SECRET_KEY:-sk-shimon-0123456789-abcdefghijklmn}"
      STORAGE_TYPE: "local"
      STORAGE_LOCAL_PATH: "/app/api/storage"
      OLLAMA_API_BASE: "http://ollama:11434"
      CELERY_BROKER_URL: "redis://:${REDIS_PASSWORD:-dify_redis_secure_password}@redis:6379/1"
      CELERY_RESULT_BACKEND: "redis://:${REDIS_PASSWORD:-dify_redis_secure_password}@redis:6379/1"
    entrypoint: "/bin/bash /app/api/docker/entrypoint.sh celery -A app.celery worker -P gevent -c 1 -Q dataset,generation,mail --loglevel INFO"
    depends_on:
      db:
        condition: "service_healthy"
      redis:
        condition: "service_healthy"
      weaviate:
        condition: "service_healthy"
    networks:
      - "dify_net"

  web:
    image: "langgenius/dify-web:0.10.2"
    restart: "always"
    ports:
      - "80:3000"
    environment:
      CONSOLE_API_URL: "http://localhost:5001"
      APP_API_URL: "http://localhost:5001"
    depends_on:
      - "api"
    networks:
      - "dify_net"

volumes:
  db_data:
  redis_data:
  weaviate_data:

networks:
  dify_net:
    driver: "bridge"