version: '3'

services:
  # ----------------------------------------------------------------
  # Core Infrastructure (DB, Cache)
  # ----------------------------------------------------------------
  db:
    image: postgres:15-alpine
    restart: always
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - ./volumes/db/data:/var/lib/postgresql/data
    networks:
      - dify_net

  redis:
    image: redis:6-alpine
    restart: always
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - ./volumes/redis/data:/data
    networks:
      - dify_net

  # ----------------------------------------------------------------
  # Inference Engine
  # ----------------------------------------------------------------
  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    restart: always
    ports:
      - "11434:11434"
    volumes:
      - ./volumes/ollama:/root/.ollama
    networks:
      - dify_net

  # ----------------------------------------------------------------
  # Dify Services
  # ----------------------------------------------------------------
  api:
    image: langgenius/dify-api:latest
    restart: always
    environment:
      # Database
      DB_USERNAME: postgres
      DB_PASSWORD: ${POSTGRES_PASSWORD}
      DB_HOST: db
      DB_PORT: 5432
      DB_DATABASE: ${POSTGRES_DB}
      
      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      
      # App Settings
      SECRET_KEY: ${SECRET_KEY}
      LOG_LEVEL: INFO
      
      # Model Providers (Ollama)
      OLLAMA_API_BASE: http://ollama:11434
      
    depends_on:
      - db
      - redis
    volumes:
      - ./volumes/app/storage:/app/api/storage
    networks:
      - dify_net

  worker:
    image: langgenius/dify-api:latest
    restart: always
    environment:
      DB_USERNAME: postgres
      DB_PASSWORD: ${POSTGRES_PASSWORD}
      DB_HOST: db
      DB_PORT: 5432
      DB_DATABASE: ${POSTGRES_DB}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      SECRET_KEY: ${SECRET_KEY}
      OLLAMA_API_BASE: http://ollama:11434
    entrypoint: /bin/bash /app/api/docker/entrypoint.sh celery -A app.celery worker -P gevent -c 1 -Q dataset,generation,mail --loglevel INFO
    depends_on:
      - db
      - redis
    networks:
      - dify_net

  web:
    image: langgenius/dify-web:latest
    restart: always
    ports:
      - "80:3000"
    environment:
      CONSOLE_API_URL: ${CONSOLE_API_URL}
      APP_API_URL: ${APP_API_URL}
    depends_on:
      - api
    networks:
      - dify_net

  # Nginx proxy if needed for advanced routing (Optional, omitted for simplicity in POC)

networks:
  dify_net:
    driver: bridge
